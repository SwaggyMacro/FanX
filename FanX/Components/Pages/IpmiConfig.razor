@page "/ipmi-config"
@attribute [Authorize(Roles = "Admin")]
@using FanX.Resources
@inject IpmiConfigService IpmiConfigService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject LocalizationService LocalizationService
@inject SensorDataService SensorDataService
@implements IDisposable

<PageTitle>@Localization.IpmiConfiguration</PageTitle>
<MudCard>
    <MudTable Items="_configs" Hover="true" Striped="true" Dense="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">@Localization.IpmiConfiguration</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => OpenConfigDialog(0))">
                @LocalizationService.GetLocalizedString("AddServer")
            </MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>@Localization.Active</MudTh>
            <MudTh>@LocalizationService.GetLocalizedString("ServerName")</MudTh>
            <MudTh>@Localization.HostnameOrIpAddress</MudTh>
            <MudTh>@Localization.Username</MudTh>
            <MudTh>@Localization.Enabled</MudTh>
            <MudTh>@Localization.Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@Localization.Active">
                @if (context.Id == _activeConfigId)
                {
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                }
                else
                {
                    <MudIconButton Icon="@Icons.Material.Filled.RadioButtonUnchecked"
                                   Disabled="!context.IsEnabled"
                                   Title="@LocalizationService.GetLocalizedString("SetActiveServer")"
                                   OnClick="@(() => SetActiveConfig(context))" />
                }
            </MudTd>
            <MudTd DataLabel="@LocalizationService.GetLocalizedString("ServerName")">@GetServerName(context)</MudTd>
            <MudTd DataLabel="@Localization.HostnameOrIpAddress">@context.Host</MudTd>
            <MudTd DataLabel="@Localization.Username">@context.Username</MudTd>
            <MudTd DataLabel="@Localization.Enabled">@GetEnabledLabel(context)</MudTd>
            <MudTd DataLabel="@Localization.Actions">
                <MudIconButton Icon="@GetToggleIcon(context)"
                               Color="@GetToggleColor(context)"
                               Title="@GetToggleTitle(context)"
                               OnClick="@(() => ToggleConfigEnabled(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenConfigDialog(context.Id))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Title="@Localization.Delete" OnClick="@(() => DeleteConfig(context))" />
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>@LocalizationService.GetLocalizedString("NoServersConfigured")</MudText>
        </NoRecordsContent>
    </MudTable>
</MudCard>

@code {
    protected override void OnInitialized()
    {
        LocalizationService.OnLanguageChanged += StateHasChanged;
    }
    public void Dispose()
    {
        LocalizationService.OnLanguageChanged -= StateHasChanged;
    }
    private List<FanX.Models.IpmiConfig> _configs = [];
    private int? _activeConfigId;

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigsAsync();
    }

    private async Task LoadConfigsAsync()
    {
        _configs = await IpmiConfigService.GetConfigsAsync();
        var activeConfig = await IpmiConfigService.GetActiveConfigAsync();
        _activeConfigId = activeConfig.Id == 0 ? null : activeConfig.Id;
    }

    private async Task OpenConfigDialog(int configId)
    {
        var parameters = new DialogParameters
        {
            ["ConfigId"] = configId
        };
        var title = configId == 0
            ? LocalizationService.GetLocalizedString("AddServer")
            : LocalizationService.GetLocalizedString("EditServer");
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialogRef = await DialogService.ShowAsync<AddEditIpmiConfigDialog>(title, parameters, options);
        var result = await dialogRef.Result;
        if (result is { Canceled: false, Data: AddEditIpmiConfigDialog.IpmiConfigDialogResult dialogResult })
        {
            if (dialogResult.Deleted)
            {
                await HandleDeleteSuccessAsync();
                return;
            }
            if (dialogResult.Config != null)
            {
                if (dialogResult.Config.IsEnabled)
                {
                    await IpmiConfigService.SetActiveConfigAsync(dialogResult.Config.Id);
                }
                Snackbar.Add(LocalizationService.GetLocalizedString("ServerSavedSuccess"), Severity.Success);
            }
            SensorDataService.ClearCache();
            await LoadConfigsAsync();
        }
    }

    private async Task SetActiveConfig(FanX.Models.IpmiConfig config)
    {
        if (!config.IsEnabled)
        {
            Snackbar.Add(Localization.Disabled, Severity.Warning);
            return;
        }

        await IpmiConfigService.SetActiveConfigAsync(config.Id);
        _activeConfigId = config.Id;
        SensorDataService.ClearCache();
        Snackbar.Add(LocalizationService.GetLocalizedString("ActiveServerSet"), Severity.Success);
    }

    private async Task ToggleConfigEnabled(FanX.Models.IpmiConfig config)
    {
        config.IsEnabled = !config.IsEnabled;
        await IpmiConfigService.SaveConfigAsync(config);
        SensorDataService.ClearCache();
        await LoadConfigsAsync();
    }

    private async Task DeleteConfig(FanX.Models.IpmiConfig config)
    {
        var result = await DialogService.ShowMessageBox(
            Localization.ConfirmDeletion,
            LocalizationService.GetLocalizedString("ConfirmDeleteServerMessage"),
            yesText: Localization.Delete,
            cancelText: Localization.Cancel);

        if (result == true)
        {
            var deleted = await IpmiConfigService.DeleteConfigAsync(config.Id);
            if (!deleted)
            {
                Snackbar.Add(LocalizationService.GetLocalizedString("ServerDeleteFailed"), Severity.Error);
                return;
            }
            await HandleDeleteSuccessAsync();
        }
    }

    private string GetServerName(FanX.Models.IpmiConfig config)
    {
        return string.IsNullOrWhiteSpace(config.Name) ? "-" : config.Name;
    }

    private string GetEnabledLabel(FanX.Models.IpmiConfig config)
    {
        return config.IsEnabled ? Localization.Enabled : Localization.Disabled;
    }

    private async Task HandleDeleteSuccessAsync()
    {
        Snackbar.Add(LocalizationService.GetLocalizedString("ServerDeletedSuccess"), Severity.Success);
        SensorDataService.ClearCache();
        await LoadConfigsAsync();
    }

    private string GetToggleIcon(FanX.Models.IpmiConfig config)
    {
        return config.IsEnabled ? Icons.Material.Filled.ToggleOn : Icons.Material.Filled.ToggleOff;
    }

    private Color GetToggleColor(FanX.Models.IpmiConfig config)
    {
        return config.IsEnabled ? Color.Success : Color.Default;
    }

    private string GetToggleTitle(FanX.Models.IpmiConfig config)
    {
        return config.IsEnabled
            ? LocalizationService.GetLocalizedString("DisableServer")
            : LocalizationService.GetLocalizedString("EnableServer");
    }
}
